<% if logged_in? %>
  <div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <a href="<%= new_community_path %>" class="btn btn-primary">Create Community</a>
  </div>

  <% if @recent_posts.any? %>
    <div style="margin-bottom: 2rem;">
      <h2 style="margin-bottom: 1rem;">Recent Posts</h2>
      <div class="post-list">
        <% @recent_posts.each do |post| %>
          <%= render "posts/post_card", post: post, community: post.community %>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="grid grid-2">
    <div>
      <h2 style="margin-bottom: 1rem;">Your Communities</h2>
      <% if @my_communities.any? %>
        <% @my_communities.each do |community| %>
          <div class="card community-card">
            <div class="community-info">
              <h3><a href="<%= community_path(community) %>"><%= community.name %></a></h3>
              <p class="community-meta"><%= community.category.titleize %> &middot; <%= community.member_count %> members</p>
            </div>
            <div class="community-stats">
              <div>
                <div class="stat-value"><%= @active_proposal_counts[community.id] || 0 %></div>
                <div class="stat-label">Active</div>
              </div>
              <div>
                <div class="stat-value"><%= community.laws.size %></div>
                <div class="stat-label">Laws</div>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="card empty-state">
          <h3>No communities yet</h3>
          <p>Create or join a community to get started.</p>
        </div>
      <% end %>

      <% if @other_communities.any? %>
        <h2 style="margin: 2rem 0 1rem;">Explore Communities</h2>
        <% @other_communities.each do |community| %>
          <div class="card community-card">
            <div class="community-info">
              <h3><a href="<%= community_path(community) %>"><%= community.name %></a></h3>
              <p class="community-meta"><%= community.category.titleize %> &middot; <%= community.member_count %> members</p>
            </div>
            <div class="community-stats">
              <div>
                <div class="stat-value"><%= @active_proposal_counts[community.id] || 0 %></div>
                <div class="stat-label">Active</div>
              </div>
              <div>
                <div class="stat-value"><%= community.laws.size %></div>
                <div class="stat-label">Laws</div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <div>
      <h2 style="margin-bottom: 1rem;">Recent Proposals</h2>
      <% if @recent_proposals.any? %>
        <% @recent_proposals.each do |proposal| %>
          <div class="card proposal-card">
            <div class="proposal-header">
              <h3 class="proposal-title">
                <a href="<%= community_proposal_path(proposal.community, proposal) %>"><%= proposal.title %></a>
              </h3>
              <span class="status-badge status-voting">Voting</span>
            </div>
            <p class="proposal-meta">
              in <%= proposal.community.name %> &middot;
              <%= time_ago_in_words(proposal.voting_ends_at) %> left
            </p>
          </div>
        <% end %>
      <% else %>
        <div class="card empty-state">
          <h3>No active proposals</h3>
          <p>Proposals from your communities will appear here.</p>
        </div>
      <% end %>

      <h2 style="margin: 2rem 0 1rem;">Activity Feed</h2>
      <% if @recent_activities.any? %>
        <div class="activities-list">
          <% @recent_activities.each do |activity| %>
            <%= render "activities/activity", activity: activity %>
          <% end %>
        </div>
        <div style="margin-top: 1rem;">
          <a href="<%= activities_path %>" class="btn btn-secondary btn-small">View All Activity</a>
        </div>
      <% else %>
        <div class="card empty-state">
          <h3>No activity yet</h3>
          <p>Activity from your communities will appear here.</p>
        </div>
      <% end %>
    </div>
  </div>

<% else %>
  <div style="text-align: center; padding: 3rem 0;">
    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Common Consensus</h1>
    <p style="font-size: 1.25rem; color: var(--text-muted); max-width: 600px; margin: 0 auto 2rem;">
      A transparent platform for community decision-making. Create proposals, build consensus, and establish laws together.
    </p>
    <div style="display: flex; gap: 1rem; justify-content: center;">
      <a href="<%= signup_path %>" class="btn btn-primary btn-large">Get Started</a>
      <a href="<%= login_path %>" class="btn btn-secondary btn-large">Sign In</a>
    </div>
  </div>

  <% if @recent_posts.any? %>
    <div style="margin-top: 3rem;">
      <h2 style="margin-bottom: 1.5rem;">Recent Posts</h2>
      <div class="post-list">
        <% @recent_posts.each do |post| %>
          <%= render "posts/post_card", post: post, community: post.community %>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>

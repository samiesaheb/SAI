<% if logged_in? %>
  <div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <a href="<%= new_community_path %>" class="btn btn-primary">Create Community</a>
  </div>

  <div class="grid grid-2" style="margin-bottom: 2rem;">
    <div>
      <h2 style="margin-bottom: 1rem;">Recent Posts</h2>
      <% if @recent_posts.any? %>
        <div class="post-list">
          <% @recent_posts.each do |post| %>
            <%= render "posts/post_card", post: post, community: post.community %>
          <% end %>
        </div>
      <% else %>
        <div class="card empty-state">
          <h3>No posts yet</h3>
          <p>Posts from your communities will appear here.</p>
        </div>
      <% end %>
    </div>

    <div>
      <h2 style="margin-bottom: 1rem;">Recent Memes</h2>
      <% if @recent_memes.any? %>
        <div class="meme-grid" style="grid-template-columns: repeat(2, 1fr);">
          <% @recent_memes.each do |meme| %>
            <%= render "memes/meme_card", meme: meme, community: meme.community %>
          <% end %>
        </div>
      <% else %>
        <div class="card empty-state">
          <h3>No memes yet</h3>
          <p>Memes from your communities will appear here.</p>
        </div>
      <% end %>
    </div>
  </div>

<% else %>
  <div style="text-align: center; padding: 3rem 0;">
    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Common Consensus</h1>
    <p style="font-size: 1.25rem; color: var(--text-muted); max-width: 600px; margin: 0 auto 2rem;">
      A transparent platform for community decision-making. Create proposals, build consensus, and establish laws together.
    </p>
    <div style="display: flex; gap: 1rem; justify-content: center;">
      <a href="<%= signup_path %>" class="btn btn-primary btn-large">Get Started</a>
      <a href="<%= login_path %>" class="btn btn-secondary btn-large">Sign In</a>
    </div>
  </div>

  <% if @recent_posts.any? %>
    <div style="margin-top: 3rem; margin-bottom: 2rem;">
      <h2 style="margin-bottom: 1.5rem;">Recent Posts</h2>
      <div class="post-list">
        <% @recent_posts.each do |post| %>
          <%= render "posts/post_card", post: post, community: post.community %>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>

<div style="margin-bottom: 2rem;">
  <h2 style="margin-bottom: 1rem;">Active Proposals</h2>
  <% if @recent_proposals.any? %>
    <div class="grid grid-2">
      <% @recent_proposals.each do |proposal| %>
        <a href="<%= community_proposal_path(proposal.community, proposal) %>" class="card proposal-card clickable-card">
          <div class="proposal-header">
            <h3 class="proposal-title"><%= proposal.title %></h3>
            <span class="status-badge status-voting">Voting</span>
          </div>
          <p class="proposal-meta">
            in <%= proposal.community.name %> &middot;
            by <%= proposal.author.display_name_or_username %> &middot;
            <%= time_ago_in_words(proposal.voting_ends_at) %> left
          </p>
          <div class="vote-progress" style="margin-top: 0.75rem;">
            <div class="progress-label">
              <span>Yes: <%= proposal.yes_percentage %>%</span>
              <span><%= proposal.total_votes %> votes</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill yes" style="width: <%= proposal.yes_percentage %>%;"></div>
            </div>
          </div>
        </a>
      <% end %>
    </div>
  <% else %>
    <div class="card empty-state">
      <h3>No active proposals</h3>
      <p>Proposals from communities will appear here.</p>
    </div>
  <% end %>
</div>

<% if logged_in? %>
  <div class="grid grid-2">
    <div>
      <h2 style="margin-bottom: 1rem;">Your Communities</h2>
      <% if @my_communities.any? %>
        <% @my_communities.each do |community| %>
          <a href="<%= community_path(community) %>" class="card community-card clickable-card">
            <div class="community-info">
              <h3><%= community.name %></h3>
              <p class="community-meta"><%= community.category.titleize %> &middot; <%= community.member_count %> members</p>
            </div>
            <div class="community-stats">
              <div>
                <div class="stat-value"><%= @active_proposal_counts[community.id] || 0 %></div>
                <div class="stat-label">Active</div>
              </div>
              <div>
                <div class="stat-value"><%= community.laws.size %></div>
                <div class="stat-label">Laws</div>
              </div>
            </div>
          </a>
        <% end %>
      <% else %>
        <div class="card empty-state">
          <h3>No communities yet</h3>
          <p>Create or join a community to get started.</p>
        </div>
      <% end %>

      <% if @other_communities.any? %>
        <h2 style="margin: 2rem 0 1rem;">Explore Communities</h2>
        <% @other_communities.each do |community| %>
          <a href="<%= community_path(community) %>" class="card community-card clickable-card">
            <div class="community-info">
              <h3><%= community.name %></h3>
              <p class="community-meta"><%= community.category.titleize %> &middot; <%= community.member_count %> members</p>
            </div>
            <div class="community-stats">
              <div>
                <div class="stat-value"><%= @active_proposal_counts[community.id] || 0 %></div>
                <div class="stat-label">Active</div>
              </div>
              <div>
                <div class="stat-value"><%= community.laws.size %></div>
                <div class="stat-label">Laws</div>
              </div>
            </div>
          </a>
        <% end %>
      <% end %>
    </div>

    <div>
      <h2 style="margin-bottom: 1rem;">Activity Feed</h2>
      <% if @recent_activities.any? %>
        <div class="activities-list">
          <% @recent_activities.each do |activity| %>
            <%= render "activities/activity", activity: activity %>
          <% end %>
        </div>
        <div style="margin-top: 1rem;">
          <a href="<%= activities_path %>" class="btn btn-secondary btn-small">View All Activity</a>
        </div>
      <% else %>
        <div class="card empty-state">
          <h3>No activity yet</h3>
          <p>Activity from your communities will appear here.</p>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

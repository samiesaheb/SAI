<div class="post-show-wrapper">
  <nav class="post-breadcrumb">
    <a href="<%= community_path(@community) %>"><%= @community.name %></a>
    <span class="breadcrumb-sep">/</span>
    <a href="<%= community_posts_path(@community) %>">Posts</a>
  </nav>

  <div class="post-show">
    <div class="post-show-content">
      <div class="post-show-badges">
        <span class="post-category-pill"><%= @post.category_label %></span>
        <% if @post.canon? %>
          <span class="post-canon-pill">Canon</span>
        <% end %>
        <% if @post.locked? %>
          <span class="post-locked-pill">Locked</span>
        <% end %>
        <% if @post.quality_score > 0 %>
          <span class="post-quality-pill quality-<%= @post.quality_score >= 70 ? 'high' : @post.quality_score >= 40 ? 'medium' : 'low' %>">
            Quality: <%= @post.quality_score %>
          </span>
        <% end %>
        <span class="post-word-pill"><%= @post.word_count %> words</span>
      </div>

      <h1 class="post-title"><%= @post.title %></h1>

      <div class="post-author-bar">
        <div class="post-author-avatar">
          <%= @post.author.display_name_or_username[0].upcase %>
        </div>
        <div class="post-author-details">
          <a href="<%= user_path(username: @post.author.username) %>" class="profile-link post-author-name"><%= @post.author.display_name_or_username %></a>
          <span class="post-author-time"><%= time_ago_in_words(@post.created_at) %> ago</span>
        </div>
      </div>

      <div class="post-body">
        <%= simple_format(@post.body) %>
      </div>

      <% if @post.parsed_sources.any? %>
        <div class="post-sources">
          <h3>Sources & Citations</h3>
          <ul>
            <% @post.parsed_sources.each do |source| %>
              <li>
                <% if source["url"].present? %>
                  <a href="<%= source["url"] %>" target="_blank" rel="noopener"><%= source["title"].presence || source["url"] %></a>
                <% else %>
                  <%= source["title"] %>
                <% end %>
                <% if source["author"].present? %>
                  <span class="source-author">â€” <%= source["author"] %></span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

    <div class="post-show-sidebar">
      <div class="post-vote-large" id="post-vote-large-<%= @post.id %>">
        <%= render "shared/post_votes_large", post: @post, community: @community %>
      </div>

      <div class="post-sidebar-info">
        <% if @post.ml_category.present? && @post.ml_category != @post.category %>
          <div class="ml-info">
            <span class="ml-label">ML Suggested:</span> <%= @post.ml_category.titleize %>
          </div>
        <% end %>

        <% if @post.canon? %>
          <div class="canon-info">
            <strong>Achieved Canon Status</strong><br>
            <%= @post.canon_at.strftime("%B %d, %Y") %>
          </div>
        <% end %>

        <% if @post.bitcoin_block_height.present? %>
          <div class="bitcoin-stamp">
            <strong>Bitcoin Block Stamp</strong><br>
            Block #<%= @post.bitcoin_block_height %><br>
            <code class="block-hash-truncated"><%= @post.bitcoin_block_hash.to_s[0..15] %>...</code>
          </div>
        <% end %>

        <% if @post.locked? %>
          <div class="lock-info">
            Locked for <%= @post.locked_until_block - Block.current_height %> more blocks
          </div>
        <% end %>

        <div class="meme-actions">
          <% if @post.author == current_user || current_user.admin_of?(@community) %>
            <%= button_to "Delete", community_post_path(@community, @post), method: :delete, class: "btn btn-danger btn-small", data: { confirm: "Delete this post?" } %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="comments-section">
    <h2 class="comments-header">Comments (<%= @post.comments.count %>)</h2>

    <% if logged_in? && @is_member %>
      <%= render "comments/form", community: @community, commentable: @post %>
    <% elsif !logged_in? %>
      <p class="comment-login-prompt"><a href="<%= login_path %>">Log in</a> to comment.</p>
    <% end %>

    <div class="comments-list">
      <% if @comments.any? %>
        <% @comments.each do |comment| %>
          <%= render "comments/comment", comment: comment, community: @community, commentable: @post %>
        <% end %>
      <% else %>
        <p class="comments-empty">No comments yet. Be the first to share your thoughts!</p>
      <% end %>
    </div>
  </div>
</div>
